<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SuperSplat Viewer</title>
    <style>
        * { margin: 0; padding: 0; touch-action: none; }
        body { overflow: hidden; background-color: rgb(102, 102, 102); }
        .hidden { display: none !important; }
        #loadingIndicator {
            font-family: 'Arial', sans-serif;
            color: #2c3e50;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "playcanvas": "https://cdn.jsdelivr.net/npm/playcanvas@2.3.3/build/playcanvas.mjs"
            }
        }
    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@playcanvas/web-components@0.1.10/dist/pwc.mjs"></script>
</head>
<body>
    <input type="file" id="fileInput" accept=".ply" style="position: fixed; top: 16px; left: 16px; z-index: 999;" />
    <div id="loadingIndicator" class="hidden">Loading...</div>

    <pc-app antialias="false" depth="false" high-resolution="true" stencil="false">
        <pc-scene>
            <pc-entity name="camera root">
                <pc-entity name="camera">
                    <pc-camera clear-color="0.4 0.4 0.4" fov="50.00"></pc-camera>
                </pc-entity>
            </pc-entity>
            <pc-entity name="light" rotation="35 45 0">
                <pc-light color="white" intensity="1.5"></pc-light>
            </pc-entity>
        </pc-scene>
    </pc-app>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            const fileInput = document.getElementById('fileInput');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const appElement = await document.querySelector('pc-app').ready();
            const app = await appElement.app;

            // 初始化場景中可能已存在的舊資產
            let currentSplatEntity = null;

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // 顯示加載指示器
                loadingIndicator.classList.remove('hidden');

                try {
                    // 清除舊的 3D 模型實體
                    if (currentSplatEntity) {
                        app.root.removeChild(currentSplatEntity);
                        currentSplatEntity.destroy();
                        currentSplatEntity = null;
                    }

                    // 將檔案轉成 URL
                    const fileURL = URL.createObjectURL(file);

                    // 創建並加載 PLY 資源
                    const plyAsset = new pc.Asset('uploadedPly', 'gsplat', { url: fileURL });
                    app.assets.add(plyAsset);

                    plyAsset.on('load', () => {
                        // 創建新的 splat 實體
                        currentSplatEntity = new pc.Entity('splat');
                        currentSplatEntity.addComponent('splat', { asset: plyAsset });

                        // 將實體添加到場景
                        app.root.addChild(currentSplatEntity);

                        // 隱藏加載指示器
                        loadingIndicator.classList.add('hidden');
                    });

                    // 開始加載資產
                    app.assets.load(plyAsset);
                } catch (error) {
                    console.error('Error loading PLY file:', error);
                    loadingIndicator.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
